<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Choir - Marker</title>
    <link rel="icon" type="image/png" href="./../favicon.png">
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
</head>
<body class="bg-slate-900 text-white min-h-screen pb-40">

    <div id="loginOverlay" class="fixed inset-0 bg-slate-900 z-[100] flex items-center justify-center p-6">
        <div class="bg-white p-8 rounded-3xl shadow-2xl w-full max-w-sm text-slate-900">
            <h2 class="text-2xl font-black mb-2 text-center">Parish Admin</h2>
            <p class="text-slate-500 text-sm mb-6 text-center">Please log in to manage attendance.</p>
            
            <input id="email" type="email" placeholder="Email" class="w-full border p-3 rounded-xl mb-3 outline-none focus:ring-2 focus:ring-blue-500">
            <input id="password" type="password" placeholder="Password" class="w-full border p-3 rounded-xl mb-6 outline-none focus:ring-2 focus:ring-blue-500">
            
            <button onclick="handleLogin()" id="loginBtn" class="w-full bg-blue-600 text-white p-4 rounded-xl font-bold shadow-lg active:scale-95 transition-all">
                Login
            </button>
            <p id="loginError" class="text-red-500 text-xs mt-4 hidden text-center"></p>
        </div>
    </div>

    <div class="max-w-md mx-auto p-4">
        <header class="text-center mb-8 pt-4">
            <h1 id="dateDisplay" class="text-2xl font-bold text-blue-400"></h1>
            <p id="infoDisplay" class="text-slate-500 text-xs mt-1 uppercase tracking-widest font-black"></p>
            <button onclick="openSpecialMass()" class="bg-orange-600 text-white px-4 py-2 rounded-full text-[10px] font-black uppercase shadow-lg shadow-orange-900/40">
                + Special Mass
            </button>
            <button onclick="handleLogout()" class="text-xs font-bold text-slate-400 hover:text-red-500">LOGOUT</button>
            <div id="massTabs" class="flex flex-wrap justify-center gap-2 mt-6"></div>
        </header>

        <div id="memberList" class="space-y-3">
            <p class="text-center py-10 text-slate-600 italic">Fetching records...</p>
        </div>

        <div id="summaryPanel" class="hidden fixed bottom-6 left-1/2 -translate-x-1/2 w-[90%] max-w-md bg-slate-800 border border-slate-700 p-5 rounded-3xl shadow-2xl z-40">
            <div class="flex justify-between items-center mb-3">
                <h4 class="text-sm font-bold text-slate-400 uppercase tracking-tight">Daily Summary</h4>
                <button onclick="hideSummary()" class="text-slate-500 text-xs">âœ• Close</button>
            </div>
            <pre id="summaryText" class="text-[11px] bg-slate-900 p-3 rounded-xl overflow-x-auto whitespace-pre-wrap text-slate-300 leading-relaxed max-h-40 mb-4"></pre>
            <div class="flex gap-2">
                <button onclick="copyToClipboard()" class="flex-1 bg-slate-700 hover:bg-slate-600 p-3 rounded-xl text-xs font-bold transition-all">Copy Text</button>
                <button onclick="shareOnWhatsApp()" class="flex-1 bg-green-600 hover:bg-green-500 p-3 rounded-xl text-xs font-bold transition-all">Share on WhatsApp</button>
            </div>
        </div>

        <div class="fixed bottom-0 left-0 w-full p-4 bg-slate-900/90 backdrop-blur-md border-t border-slate-800">
            <button onclick="submitAttendance()" class="w-full max-w-md mx-auto block bg-blue-600 hover:bg-blue-500 py-4 rounded-2xl font-bold text-lg shadow-xl active:scale-95 transition-all">
                Submit Attendance
            </button>
        </div>
    </div>

    <div id="subModal" class="hidden fixed inset-0 bg-black/80 z-50 flex items-center justify-center p-6">
        <div class="bg-slate-800 rounded-3xl w-full max-w-sm p-6 border border-slate-700">
            <h3 class="text-xl font-bold mb-4">Select Substitute</h3>
            <div id="allMembersList" class="grid grid-cols-1 gap-2 max-h-80 overflow-y-auto"></div>
            <button onclick="closeSubModal()" class="mt-6 w-full py-3 text-slate-400 font-semibold">Cancel</button>
        </div>
    </div>

    <script>
        const SUPABASE_URL = 'https://gkhozoahwpqxhecoclpy.supabase.co';
        const SUPABASE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImdraG96b2Fod3BxeGhlY29jbHB5Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NzAxMTA0NjMsImV4cCI6MjA4NTY4NjQ2M30._lBdGbRDlpkbiUP65Cpong-c81MX6NlUH2k9IZ9I7XM';
        const db = supabase.createClient(SUPABASE_URL, SUPABASE_KEY);

        let scheduledMembers = [];
        let allMembers = [];
        let attendanceState = {}; 
        let currentMass = "";
        
        const days = ["Sunday", "Monday", "Tuesday", "Wednesday", "Thursday", "Friday", "Saturday"];
        const now = new Date();
        const todayName = days[now.getDay()];
        const todayDate = now.toISOString().split('T')[0];

        // --- AUTH LOGIC ---
        async function checkUser() {
            const { data: { user } } = await db.auth.getUser();
            if (user) {
                document.getElementById('loginOverlay').classList.add('hidden');
                init();
            }
        }

        async function handleLogin() {
            const email = document.getElementById('email').value;
            const password = document.getElementById('password').value;
            const btn = document.getElementById('loginBtn');
            btn.innerText = "Wait...";
            const { error } = await db.auth.signInWithPassword({ email, password });
            if (error) {
                document.getElementById('loginError').innerText = error.message;
                document.getElementById('loginError').classList.remove('hidden');
                btn.innerText = "Login";
            } else { location.reload(); }
        }

        async function handleLogout() {
            await db.auth.signOut();
            location.reload();
        }

        async function init() {
            document.getElementById('dateDisplay').innerText = `${todayName}, ${now.toLocaleDateString('en-IN')}`;
            let defaultTimes = (todayName === "Thursday") ? ["6:00 AM", "5:00 PM"] : 
                               (todayName === "Sunday") ? ["6:00 AM", "10:00 AM", "4:00 PM"] : ["6:00 AM", "7:00 AM"];
            currentMass = defaultTimes[0];
            renderMassTabs(defaultTimes);
            await fetchAllMembers();
            await fetchScheduledMembers();
        }

        function renderMassTabs(timings) {
            const container = document.getElementById('massTabs');
            container.innerHTML = timings.map(t => `
                <button onclick="changeMass('${t}', this)" 
                    class="mass-btn px-5 py-2 rounded-full text-xs font-black transition-all ${currentMass === t ? 'bg-blue-600 text-white shadow-lg' : 'bg-slate-800 text-slate-500'}">
                    ${t}
                </button>
            `).join('');
        }

        let isSpecialMass = false;

        async function openSpecialMass() {
            isSpecialMass = true;
            currentMass = prompt("Enter Mass Name (e.g., 'Feast Mass', 'Wedding', 'Extra 7AM'):", "Special Mass");
            if (!currentMass) return;

            // In Special Mass mode, EVERYONE is a candidate for Extra Credit
            attendanceState = {};
            allMembers.forEach(m => {
                // Everyone starts as Absent; tapping them makes them 'Extra Credit'
                attendanceState[m.id] = { status: 'Absent', subId: null, name: m.name };
            });
            
            renderSpecialAttendanceList();
        }

        function renderSpecialAttendanceList() {
            const container = document.getElementById('memberList');
            document.getElementById('infoDisplay').innerText = "SPECIAL SESSION ENTRY";
            
            // Sort all members so the list is easy to navigate
            container.innerHTML = allMembers.map(m => {
                const state = attendanceState[m.id];
                const isPresent = state.status === 'Extra Credit';
                
                return `
                    <div onclick="toggleExtraCredit('${m.id}')" 
                        class="flex items-center justify-between p-4 rounded-2xl border-2 transition-all ${isPresent ? 'bg-orange-950/40 border-orange-500' : 'bg-slate-800/50 border-transparent'}">
                        <p class="font-bold ${isPresent ? 'text-white' : 'text-slate-500'}">${m.name}</p>
                        <span class="text-[10px] font-black uppercase ${isPresent ? 'text-orange-500' : 'text-slate-700'}">
                            ${isPresent ? 'Extra Credit' : 'Tap to Add'}
                        </span>
                    </div>
                `;
            }).join('');
        }

        function toggleExtraCredit(id) {
            attendanceState[id].status = (attendanceState[id].status === 'Extra Credit') ? 'Absent' : 'Extra Credit';
            renderSpecialAttendanceList();
        }

        async function changeMass(t, btn) {
            currentMass = t;
            document.querySelectorAll('.mass-btn').forEach(b => b.className = 'mass-btn px-5 py-2 rounded-full text-xs font-black transition-all bg-slate-800 text-slate-500');
            btn.className = 'mass-btn px-5 py-2 rounded-full text-xs font-black transition-all bg-blue-600 text-white shadow-lg';
            await fetchScheduledMembers();
        }

        async function fetchAllMembers() {
            const { data } = await db.from('members').select('*').order('name');
            allMembers = data || [];
        }

        async function fetchScheduledMembers() {
            const sunNum = Math.ceil(now.getDate() / 7);
            document.getElementById('infoDisplay').innerText = todayName === "Sunday" ? `Sunday Group ${sunNum}` : `Regular Schedule`;

            // 1. Check if Attendance already exists for today/mass
            const { data: existingRecords } = await db.from('attendance')
                .select('*')
                .eq('date', todayDate)
                .eq('mass_timing', currentMass);

            // 2. Fetch the Schedule Template
            let query = db.from('schedules').select('member_id, members(name)').eq('day_of_week', todayName).eq('mass_timing', currentMass);
            if (todayName === "Sunday") query = query.eq('sunday_number', sunNum);
            const { data: scheduled } = await query;
            scheduledMembers = scheduled || [];

            // 3. Merge: If record exists, use it. Otherwise, default to Absent.
            attendanceState = {};
            scheduledMembers.forEach(m => {
                const existing = existingRecords?.find(r => r.scheduled_member_id === m.member_id);
                if (existing) {
                    attendanceState[m.member_id] = { 
                        status: existing.status, 
                        subId: (existing.status === 'Substituted' ? existing.actual_attendee_id : null), 
                        name: m.members.name 
                    };
                } else {
                    attendanceState[m.member_id] = { status: 'Absent', subId: null, name: m.members.name };
                }
            });
            renderAttendanceList();
        }

        function renderAttendanceList() {
            const container = document.getElementById('memberList');
            if (scheduledMembers.length === 0) { container.innerHTML = `<div class="py-20 text-center text-slate-600 italic">No schedules for ${currentMass}</div>`; return; }

            container.innerHTML = scheduledMembers.map(m => {
                const state = attendanceState[m.member_id];
                const isPresent = state.status === 'Present';
                const isSub = state.status === 'Substituted';
                return `
                    <div class="flex items-center justify-between p-4 rounded-2xl border-2 transition-all duration-200 ${isPresent ? 'bg-green-950/40 border-green-500' : isSub ? 'bg-blue-950/40 border-blue-500' : 'bg-slate-800/50 border-transparent'}">
                        <div class="flex-1 cursor-pointer" onclick="toggleStatus('${m.member_id}')">
                            <p class="font-bold text-lg ${!isPresent && !isSub ? 'text-slate-400' : 'text-white'}">${m.members.name}</p>
                            <p class="text-[10px] uppercase font-black tracking-tighter ${isPresent ? 'text-green-500' : isSub ? 'text-blue-400' : 'text-slate-600'}">
                                ${isSub ? 'Substituted by ' + getMemberName(state.subId) : state.status}
                            </p>
                        </div>
                        <button onclick="openSubModal('${m.member_id}')" class="bg-slate-800 px-4 py-2 rounded-xl text-[10px] font-black tracking-widest border border-slate-700">SUB</button>
                    </div>`;
            }).join('');
        }

        function toggleStatus(id) {
            attendanceState[id].status = (attendanceState[id].status === 'Present') ? 'Absent' : 'Present';
            attendanceState[id].subId = null;
            renderAttendanceList();
        }

        let activeSubTarget = null;
        function openSubModal(targetId) {
            activeSubTarget = targetId;
            document.getElementById('allMembersList').innerHTML = allMembers.map(m => `
                <button onclick="setSubstitute('${m.id}')" class="text-left p-4 bg-slate-700/50 rounded-xl hover:bg-blue-600 transition font-bold text-sm">${m.name}</button>
            `).join('');
            document.getElementById('subModal').classList.remove('hidden');
        }
        function closeSubModal() { document.getElementById('subModal').classList.add('hidden'); }
        function setSubstitute(subId) {
            attendanceState[activeSubTarget] = { status: 'Substituted', subId: subId, name: attendanceState[activeSubTarget].name };
            closeSubModal(); renderAttendanceList();
        }
        function getMemberName(id) { return allMembers.find(m => m.id === id)?.name || "Unknown"; }

        async function submitAttendance() {
            const year = now.getFullYear();
            const month = String(now.getMonth() + 1).padStart(2, '0');
            const day = String(now.getDate()).padStart(2, '0');
            const dateStr = `${year}-${month}-${day}`;
            
            console.log("Saving attendance for local date:", dateStr);

            const records = Object.keys(attendanceState).map(id => {
                const state = attendanceState[id];
                if (isSpecialMass && state.status === 'Absent') return null;

                return {
                    date: dateStr, // Using the forced local date
                    day_name: todayName,
                    mass_timing: currentMass,
                    scheduled_member_id: isSpecialMass ? null : id,
                    actual_attendee_id: (state.status === 'Present' || state.status === 'Extra Credit') ? id : (state.status === 'Substituted' ? state.subId : null),
                    status: isSpecialMass ? 'Extra Credit' : state.status
                };
            }).filter(record => record !== null);

            if (records.length === 0) {
                alert("No attendance marked!");
                return;
            }

            // Insert into Supabase (Clean existing records for this specific mass first)
            await db.from('attendance').delete().eq('date', dateStr).eq('mass_timing', currentMass);
            const { error } = await db.from('attendance').insert(records);
            
            if (error) { alert("Error: " + error.message); return; }

            // Generate Summary Text
            const present = records.filter(r => r.status === 'Present').map(r => getMemberName(r.scheduled_member_id));
            const subs = records.filter(r => r.status === 'Substituted').map(r => `${getMemberName(r.actual_attendee_id)} (for ${getMemberName(r.scheduled_member_id)})`);
            const absent = records.filter(r => r.status === 'Absent').map(r => getMemberName(r.scheduled_member_id));

            const text = `*Choir Attendance*\n${now.toLocaleDateString('en-IN')} - ${todayName}, ${currentMass}\n\n*Present:* ${present.join(', ') || 'None'}\n\n*Subs:* ${subs.join(', ') || 'None'}\n\n*Absent:* ${absent.join(', ') || 'None'}`;
            
            document.getElementById('summaryText').innerText = text;
            document.getElementById('summaryPanel').classList.remove('hidden');
        }

        function copyToClipboard() {
            const text = document.getElementById('summaryText').innerText;
            navigator.clipboard.writeText(text);
            alert("Summary copied to clipboard!");
        }

        function shareOnWhatsApp() {
            const text = document.getElementById('summaryText').innerText;
            window.open(`https://wa.me/?text=${encodeURIComponent(text)}`);
        }

        function hideSummary() { document.getElementById('summaryPanel').classList.add('hidden'); }

        checkUser();
    </script>
</body>
</html>